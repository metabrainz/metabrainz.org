{% extends 'admin/master.html' %}
{% block body %}
  <div class="page-title">
    <i class="fa fa-bar-chart"></i> Statistics Overview
  </div>
  <p class="page-subtitle">Monitor API usage and supporter activity</p>

  <div class="row" style="margin-bottom: 20px;">
    <div class="col-md-12">
      <div class="stats-card-primary">
        <h4><i class="fa fa-users"></i> Active Supporters (Last 24 Hours)</h4>
        <p class="count">{{ active_supporter_count }}</p>
        <p style="opacity: 0.9; margin: 0; font-size: 14px;">Supporters who used the API</p>
      </div>
    </div>
  </div>

  {% if top_downloaders %}
  <div class="admin-card">
    <h3><i class="fa fa-trophy"></i> Top Downloaders (Last 24 Hours)</h3>
    <ol style="padding-left: 20px;">
      {% for supporter, req_count in top_downloaders %}
        <li class="list-item-border">
          <a href="{{ url_for('supportersview.details', supporter_id=supporter.id) }}" style="font-weight: 600;">
            {{ supporter.user.name }}
          </a>
          {% if supporter.is_commercial %}
            <span class="text-muted">({{ supporter.org_name }})</span>
          {% endif %}
          <span class="badge-orange" style="float: right;">{{ req_count }} requests</span>
        </li>
      {% endfor %}
    </ol>
  </div>
  {% endif %}

  {% if token_actions %}
  <div class="admin-card">
    <h3><i class="fa fa-key"></i> Recent Access Token Changes</h3>
    <ol style="padding-left: 20px;">
      {% for action in token_actions %}
        <li class="list-item-border">
          {% if action.supporter %}
            <a href="{{ url_for('supportersview.details', supporter_id=action.supporter.id) }}">{{ action.supporter.user.name }}</a>
          {% else %}
            <span class="text-muted">Deleted Supporter</span>
          {% endif %}
          {% if action.supporter.id == action.token.owner.id %}
            {% if action.action == "create" %}
              <span class="text-green">generated their token</span>
            {% elif action.action == "deactivate" %}
              <span class="text-danger">revoked their token</span>
            {% endif %}
          {% else %}
            {% if action.action == "create" %}
              <span class="text-green">generated new token for supporter</span>
            {% elif action.action == "deactivate" %}
              <span class="text-danger">revoked token owned by supporter</span>
            {% endif %}
            {% if action.token.owner %}
                <a href="{{ url_for('supportersview.details', supporter_id=action.token.owner.id) }}">{{ action.token.owner }}</a>
            {% else %}
                <span class="text-muted">[ invalid owner ]</span>
            {% endif %}
          {% endif %}
          <code>{{ action.token_value }}</code>
        </li>
      {% endfor %}
    </ol>
    <div style="margin-top: 15px;">
      <a href="{{ url_for('statsview.token_log') }}" class="btn btn-primary">
        <i class="fa fa-list"></i> View All Changes
      </a>
    </div>
  </div>
  {% endif %}

  <div class="admin-card">
    <h3><i class="fa fa-line-chart"></i> Hourly API Usage</h3>
    <div id="chart" style="height:500px; width:100%;"></div>
  </div>
{% endblock %}

{% block tail_js %}
  {{ super() }}

  <script>
    jQuery(function ($) {
      $.getJSON('{{ url_for('statsview.hourly_usage_data') }}', function (data) {
        Highcharts.stockChart('chart', {
          rangeSelector: { selected: 1 },
          series: data,
          yAxis: { min: 0 },
          tooltip: { enabled: false },
          credits: { enabled: false }
        });
      });
    });
  </script>
{% endblock %}
